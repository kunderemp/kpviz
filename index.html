<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  <title>Cloropeth berdasarkan data dari kawal pemilu </title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>

  <script type="text/javascript">
    function xhr(url, cb) {
      var oReq = new XMLHttpRequest();
      oReq.addEventListener("load", function () {
        cb(this.responseText);
      });
      oReq.open("GET", url);
      oReq.send();
    }

    function get(id, cb) {
      var url = 'https://kawal-c1.appspot.com/api/c/';
      xhr(url + id + '?' + new Date().getTime(), function (res) {
        cb(JSON.parse(res));
      });
    }

    function getKP(id){
      return $.getJSON('https://kawal-c1.appspot.com/api/c/'+id + '?'+ new Date().getTime());
    }

    function render() {
      $.getJSON("indo.json").then(fetchKawalPemilu);
    }

    function normalize(kabname){
      if(!kabname) return "";
      return kabname.toUpperCase().replace(/KOTA/g,"")
          .replace(/\W/g,"")
          .replace(/BULONGAN/g,"BULUNGAN")
          .replace(/PASIR/g,"PASER")
          .replace(/KEPULAUANSELAYAR/g,"SELAYAR")
          .replace(/SANGIHETALAUD/g,"SANGIHE")
          .replace(/LIMAPULUHKOTO/g,"LIMAPULUH")
          .replace(/PANGKAJENEDANKEPULAUAN/g,"PANGKAJENEKEPULAUAN")
          .replace(/ADMINKEPULAUANSERIBU/g,"KEPULAUANSERIBU")
          .replace(/KEPULAUANYAPEN/g,"YAPENWAROPEN")
          .replace(/POLEWALIMAMASA/g,"POLEWALIMANDAR")
          ;
    }

    function fetchKawalPemilu(topology) {
      getKP(0).then( idn => {
        var provinceIds = idn.children.map(p => p[0]);
        // Rodo nggilani slurup satu satu, tapi ndak papa ndak membebani KP.
        slurupKP(provinceIds, {}, topology);
      });
    }

    function slurupKP(ids, result, topology){
        if(ids.length == 0){
          $("#loading").hide();
          drawMap(topology, result);
        } else {
          var id = ids.pop();          
          getKP(id).then(data => {
            $("#loading").html($("#loading").html() + "<br>" + data.name)
            result = collect(result)(data);
            slurupKP(ids, result, topology);
          });
        }
    }

    function collect(result) {
      return function (data) {
        for (var i = 0; i < data.children.length; i++) {
          var id = data.children[i][0];
          var kabKey = normalize(data.children[i][1]);
          
          result[kabKey] = {};
          result[kabKey]['name'] = data.children[i][1];
          result[kabKey]['pas1'] = data.data[id].sum.pas1;
          result[kabKey]['pas2'] = data.data[id].sum.pas2;
        }
        return result;
      };
    };

    var width, height, svg, projection, path, g;

    function drawMap(topology, votingData) {
       width = window.innerWidth;
        height = window.innerHeight;

      var colorRange = ["#1a9850", "#66bd63", "#a6d96a", "#d9ef8b", "#ffffff", "#fee08b", "#fdae61", "#f46d43", "#d73027"];
      var votingDomain = [-1000,-100,-10,0,10,100,1000];

      // Create SVG element
      svg = d3.select("body").insert("svg", "p")
        .attr("width", width)
        .attr("height", height * 0.8)
        .attr("class", "map");

      // Projection and path
      projection = d3.geoMercator()
        .center([118.25, -5])
        .scale(width * 1.2)
        .translate([width / 2, height / 2]);

      path = d3.geoPath().projection(projection);
      console.log("Ready to draw", votingData);
      // Color
      var votingColor = d3.scaleThreshold()
        .domain(votingDomain)
        .range(colorRange);

      g = svg.append("g");

      // Draw the map
      g.selectAll("path")
        .attr("class", "city")
        .data(topojson.feature(topology, topology.objects.IDN_adm_2_kabkota).features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("stroke", "black")
        .attr("stroke-width", "0.2")
        .attr("fill", "white")
        .transition().duration(2000)
        .delay(function (d, i) {
          return i * 5;
        })
        .ease(d3.easeLinear)
        .attr("fill", function (d) {
          if (!d.properties.HASC_2) {
            return "lightblue";
          } else {
            var vd = votingData[normalize(d.properties.NAME_2)];
            if(vd){
              var p1 = vd.pas1
              var p2 = vd.pas2
              if(!p1) p1 = 0;
              if(!p2) p2 = 0;
              return votingColor(p1-p2);
            } else 
            return "lightgray";
            
          }
        });

      g.selectAll("path")
        .append("title")
        .text(function (d) {
          var vd = votingData[normalize(d.properties.NAME_2)];
          if(vd){
            if(!vd.pas1 && !vd.pas2) return "No data entry yet.";
            return vd.name + " Jokowi: " + vd.pas1 + " Prabowo: " + vd.pas2;
          } else {
            return d.properties.NAME_2 + " might be named differently in kawal pemilu";
          }
          
        });
    }


    d3.select(window).on("resize", resize);

    function resize() {
      width = window.innerWidth;
      height = window.innerHeight;

      projection.scale(width * 1.2)
        .translate([width / 2, height / 2]);

      d3.select("svg")
        .attr("width", width)
        .attr("height", height * 0.8);

      d3.selectAll("path")
        .attr("d", path);
    }

    window.onload = render;
  </script>
</head>

<body>
  <div id="loading">Loading </div>
</body>


</html>